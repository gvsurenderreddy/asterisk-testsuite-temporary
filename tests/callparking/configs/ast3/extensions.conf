[general]
static=yes
writeprotect=no
lastaction=""

[parking]
exten => c_exten,1,Answer()
exten => c_exten,n,NOOP(userC answered the call)
exten => c_exten,n,Wait(1)
exten => c_exten,n,SendDTMF(1w1w0)
exten => c_exten,n,Wait(1)
exten => c_exten,n,NOOP(trying to park the call)
exten => c_exten,n,SET(GLOBAL(lastaction)=parkedB)
exten => c_exten,n,SendDTMF(#)
exten => c_exten,n,Wait(1)
exten => c_exten,n,SendDTMF(700)
exten => c_exten,n,Hangup()

exten => h,1,GotoIF($["${GLOBAL(lastaction)}"="parkedB"]?retrieveA)
exten => h,n,Hangup()
exten => h,n(retrieveA),NOOP(Got Hangup due to successfull parking of userB -> call 701 in order to retrieve userA)
exten => h,n,AGI(agi://127.0.0.1:4575)
exten => h,n,Hangup()

exten => retrieve_A,1,NOOP(okay, I should now be connected to userA -> trying to sync)
exten => retrieve_A,n(sync),Wait(1)
exten => retrieve_A,n,Read(sync,,3,,,8) ;wait more than 5 but less than 10 seconds
exten => retrieve_A,n,GotoIf($["${sync}"="999"]?DTMFpass:DTMFfail)
exten => retrieve_A,n(DTMFpass),NOOP(read '${sync}' and expected '999' - OK)
exten => retrieve_A,n,NOOP(synchronized to userA successfully - now retrieve userB!)
exten => retrieve_A,n,Set(GLOBAL(lastaction)=successA)
exten => retrieve_A,n,AGI(agi://127.0.0.1:4576)
exten => retrieve_A,n,Hangup()
exten => retrieve_A,n(DTMFfail),NOOP(read '${sync}' and exptected '999' - FAILURE)
exten => retrieve_A,n,NOOP(trying to sync again!)
exten => retrieve_A,n,Goto(sync)

exten => retrieve_B,1,NOOP(okay, I should now be connected to userB -> trying to sync)
exten => retrieve_B,n(sync),Wait(1)
exten => retrieve_B,n,Read(sync,,3,,,8) ;wait more than 5 but less than 10 seconds
exten => retrieve_B,n,GotoIf($["${sync}"="888"]?DTMFpass:DTMFfail)
exten => retrieve_B,n(DTMFpass),NOOP(read '${sync}' and expected '888' - OK)
exten => retrieve_B,n,NOOP(TEST PASSED!)
exten => retrieve_B,n,Set(GLOBAL(lastaction)=success)
exten => retrieve_B,n,AGI(agi://127.0.0.1:4577)
exten => retrieve_B,n,Hangup()
exten => retrieve_B,n(DTMFfail),NOOP(read '${sync}' and exptected '888' - FAILURE)
exten => retrieve_B,n,NOOP(trying to sync again!)
exten => retrieve_B,n,Goto(sync)
