testinfo:
    summary: 'Test that a simple bridge works'
    description: |
        'Set up a bridge between two endpoints and ensure that things work
        as expected.'

test-modules:
    test-object:
        config-section: bridge-config
        typename: 'BridgeTestCase.BridgeTestCase'
    modules:
        -
            config-section: 'cdr-config'
            typename: 'cdr.CDRModule'
        -
            config-section: 'cel-config'
            typename: 'cel.CELModule'
        -
            typename: 'ami.AMIEventModule'
            config-section: 'ami-uut-v12'
            minversion: '12.0.0'
        -
            typename: 'ami.AMIEventModule'
            config-section: 'ami-uut-v11'
            maxversion: '12.0.0'

bridge-config:
  test-runs:
    -
        originate_channel: 'SIP/test_call@uut'
        hangup: 'alice'
    -
        originate_channel: 'SIP/test_call@uut'
        hangup: 'bob'

ami-uut-v12:
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'BridgeCreate'
        requirements:
            match:
                BridgeType: 'simple_bridge'
        count: '2'
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'BridgeEnter'
                Channel: 'SIP/alice-.*'
        requirements:
            match:
                BridgeUniqueid: '.*-.*-.*'
                BridgeType: 'simple_bridge'
                ChannelState: '6'
                ChannelStateDesc: 'Up'
                CallerIDNum: '1234'
                CallerIDName: 'Alice'
                ConnectedLineNum: '4321'
                ConnectedLineName: 'Bob'
                Context: 'default'
                Exten: 'test_call'
                Priority: '1'
                Uniqueid: '.*'
        count: '2'
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'BridgeEnter'
                Channel: 'SIP/bob-.*'
        requirements:
            match:
                BridgeUniqueid: '.*-.*-.*'
                BridgeType: 'simple_bridge'
                ChannelState: '6'
                ChannelStateDesc: 'Up'
                ConnectedLineNum: '1234'
                ConnectedLineName: 'Alice'
                CallerIDNum: '4321'
                CallerIDName: 'Bob'
                Context: 'default'
                Priority: '1'
                Uniqueid: '.*'
        count: '2'
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'BridgeLeave'
                Channel: 'SIP/alice-.*'
        requirements:
            match:
                BridgeUniqueid: '.*-.*-.*'
                BridgeType: 'simple_bridge'
                ChannelState: '6'
                ChannelStateDesc: 'Up'
                CallerIDNum: '1234'
                CallerIDName: 'Alice'
                ConnectedLineNum: '4321'
                ConnectedLineName: 'Bob'
                Context: 'default'
                Exten: 'test_call'
                Priority: '1'
                Uniqueid: '.*'
        count: '2'
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'BridgeLeave'
                Channel: 'SIP/bob-.*'
        requirements:
            match:
                BridgeUniqueid: '.*-.*-.*'
                BridgeType: 'simple_bridge'
                ChannelState: '6'
                ChannelStateDesc: 'Up'
                ConnectedLineNum: '1234'
                ConnectedLineName: 'Alice'
                CallerIDNum: '4321'
                CallerIDName: 'Bob'
                Context: 'default'
                Priority: '1'
                Uniqueid: '.*'
        count: '2'
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'BridgeDestroy'
        requirements:
            match:
                BridgeUniqueid: '.*-.*-.*'
                BridgeType: 'simple_bridge'
        count: '2'

ami-uut-v11:
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'Newstate'
                Channel: 'SIP/bob-.*'
                ChannelStateDesc: 'Up'
        requirements:
            match:
                CallerIDNum: '4321'
                CallerIDName: 'Bob'
                ConnectedLineNum: '1234'
                ConnectedLineName: 'Alice'
        count: '2'
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'Newstate'
                Channel: 'SIP/alice-.*'
                ChannelStateDesc: 'Up'
        requirements:
            match:
                CallerIDNum: '1234'
                CallerIDName: 'Alice'
                ConnectedLineNum: '4321'
                ConnectedLineName: 'Bob'
        count: '2'
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'Bridge'
                Bridgestate: 'Link'
        requirements:
            match:
                Channel1: 'SIP/alice-.*'
                Channel2: 'SIP/bob-.*'
                CallerID1: '1234'
                CallerID2: '4321'
        count: '10'
    -
        type: 'headermatch'
        id: '0'
        conditions:
            match:
                Event: 'Bridge'
                Bridgestate: 'Unlink'
        requirements:
            match:
                Channel1: 'SIP/alice-.*'
                Channel2: 'SIP/bob-.*'
                CallerID1: '1234'
                CallerID2: '4321'
        count: '10'

cdr-config:
    -
        file: 'Master'
        lines:
            -
                source: '1234'
                destination: 'test_call'
                dcontext: 'default'
                callerid: '"Alice" <1234>'
                channel: '.*/alice-.*'
                dchannel: '.*/bob-.*'
                lastapp: 'Dial'
                disposition: 'ANSWERED'
                amaflags: 'DOCUMENTATION'
            -
                source: '1234'
                destination: 'test_call'
                dcontext: 'default'
                callerid: '"Alice" <1234>'
                channel: '.*/alice-.*'
                dchannel: '.*/bob-.*'
                lastapp: 'Dial'
                disposition: 'ANSWERED'
                amaflags: 'DOCUMENTATION'

cel-config:
    -
        file: 'Master'
        lines:
            -
                eventtype: 'CHAN_START'
                cidname: 'Alice'
                cidnum: '1234'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
            -
                eventtype: 'APP_START'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
            -
                eventtype: 'CHAN_START'
                cidname: 'Bob'
                cidnum: '4321'
                channel: '.*/bob-.*'
            -
                eventtype: 'ANSWER'
                cidname: 'Bob'
                cidnum: '4321'
                channel: '.*/bob-.*'
                app: 'AppDial'
                appdata: '\(Outgoing Line\)'
            -
                eventtype: 'ANSWER'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
            -
                eventtype: 'BRIDGE_START'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
                bridgepeer: '.*/bob-.*'
            -
                eventtype: 'BRIDGE_END'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
                bridgepeer: '.*/bob-.*'
            -
                eventtype: 'HANGUP'
                cidname: 'Bob'
                cidnum: '4321'
                channel: '.*/bob-.*'
                app: 'AppDial'
                appdata: '\(Outgoing Line\)'
                eventextra: '16,.*/alice-.*'
            -
                eventtype: 'CHAN_END'
                cidname: 'Bob'
                cidnum: '4321'
                channel: '.*/bob-.*'
                app: 'AppDial'
                appdata: '\(Outgoing Line\)'
            -
                eventtype: 'APP_END'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
            -
                eventtype: 'HANGUP'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                eventextra: '16,.*/alice-.*,ANSWER'
            -
                eventtype: 'CHAN_END'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
            -
                eventtype: 'LINKEDID_END'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
            -
                eventtype: 'CHAN_START'
                cidname: 'Alice'
                cidnum: '1234'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
            -
                eventtype: 'APP_START'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
            -
                eventtype: 'CHAN_START'
                cidname: 'Bob'
                cidnum: '4321'
                channel: '.*/bob-.*'
            -
                eventtype: 'ANSWER'
                cidname: 'Bob'
                cidnum: '4321'
                channel: '.*/bob-.*'
                app: 'AppDial'
                appdata: '\(Outgoing Line\)'
            -
                eventtype: 'ANSWER'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
            -
                eventtype: 'BRIDGE_START'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
                bridgepeer: '.*/bob-.*'
            -
                eventtype: 'BRIDGE_END'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
                bridgepeer: '.*/bob-.*'
            -
                eventtype: 'HANGUP'
                cidname: 'Bob'
                cidnum: '4321'
                channel: '.*/bob-.*'
                app: 'AppDial'
                appdata: '\(Outgoing Line\)'
                eventextra: '16,.*/bob-.*'
            -
                eventtype: 'CHAN_END'
                cidname: 'Bob'
                cidnum: '4321'
                channel: '.*/bob-.*'
                app: 'AppDial'
                appdata: '\(Outgoing Line\)'
            -
                eventtype: 'APP_END'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                app: 'Dial'
            -
                eventtype: 'HANGUP'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
                eventextra: '16,.*/bob-.*,ANSWER'
            -
                eventtype: 'CHAN_END'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'
            -
                eventtype: 'LINKEDID_END'
                cidname: 'Alice'
                cidnum: '1234'
                dnid: 'test_call'
                exten: 'test_call'
                context: 'default'
                channel: '.*/alice-.*'

properties:
    minversion: '11.0.0'
    dependencies:
        - python : 'twisted'
        - python : 'starpy'
    tags:
        - bridge
