[general]

[globals]
; use this variable during debugging to see at what step the test failed
ATT_TEST_B_LEG=FAIL - never even got to read the results

[transfertest]

;Call A leg
exten => a_dial,1,Dial(IAX2/iax_a@127.0.0.1:4570/a_exten,,T)

;Call C leg
exten => 7002,1,Dial(IAX2/iax_c@127.0.0.1:4570/c_exten)

; __________________ B ______________________
exten => b_exten,1,Set(GLOBAL(ATT_TEST_B_LEG)=FAIL-made it to b_exten though)
exten => b_exten,n,Answer()
exten => b_exten,n,Playback(${TALK_AUDIO})

;SIGNAL FOR TRANSFER, then wait with audio
exten => b_exten,n,SendDTMF(*w2)
exten => b_exten,n,Playback(${TALK_AUDIO})
exten => b_exten,n,Set(GLOBAL(ATT_TEST_B_LEG)=FAIL-began transfer)

;ENTER TRANSFER EXTEN
exten => b_exten,n,SendDTMF(7w0w0w2)
exten => b_exten,n,Set(GLOBAL(ATT_TEST_B_LEG)=FAIL-after_entering_dtmf)

;WAIT FOR DTMF FROM C TO KNOW IT IS UP AND SYNCED
exten => b_exten,n,Read(B_READ,,3,,,20) ; read DTMF from C to know it is there
exten => b_exten,n,NoOp(B READ IS ${B_READ})
exten => b_exten,n,Set(GLOBAL(ATT_TEST_B_LEG)=FAIL- B_READ is ${B_READ})

;MAKE SURE DTMF IS WHAT WE EXPECT
exten => b_exten,n,Set(GLOBAL(ATT_TEST_B_LEG)=FAIL-sometime_after_checking_dtmf_results)
exten => b_exten,n,GoToIf($[${B_READ}=110]?dtmfpass:dtmffail)
exten => b_exten,n(dtmffail),Set(GLOBAL(ATT_TEST_B_LEG)=FAIL-DTMF_FROM_C_FAILED ${B_READ})
exten => b_exten,n,Hangup()
exten => b_exten,n(dtmfpass),Set(GLOBAL(ATT_TEST_B_LEG)=PASS)

;REPORT SUCCESS, at this point in the dialplay this call leg passed.
exten => b_exten,n,AGI(agi://127.0.0.1:4574) ;Tell the test script B passed

;HANGUP, now A and C will be connected
exten => b_exten,n,HangUp()
