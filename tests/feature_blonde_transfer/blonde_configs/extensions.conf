[general]

[globals]
; these global variables can be used during debugging to view what step went wrong
BLONDE_TEST_A_LEG=FAIL-never even got to read the results
BLONDE_TEST_C_LEG=FAIL-never even got to read the results

[transfertest]

; __________________ A ______________________
exten => a_exten,1,Answer()
exten => a_exten,n,Set(GLOBAL(BLONDE_TEST_A_LEG)=FAIL-answered call from B)

;Play back audio while B leg begins to start transfer. This
;involves some timing.  Playback is done 4 times to guarantee
;that B has begun the transfer before we start listening for DTMF.
exten => a_exten,n,Playback(${TALK_AUDIO})
exten => a_exten,n,Playback(${TALK_AUDIO})
exten => a_exten,n,Playback(${TALK_AUDIO})
exten => a_exten,n,Playback(${TALK_AUDIO})

;WAIT FOR DTMF FROM C TO KNOW IT IS UP AND SYNCED
exten => a_exten,n,Set(GLOBAL(BLONDE_TEST_A_LEG)=FAIL-after reading DTMF from C)
exten => a_exten,n,Read(A_READ,,3,,,25)
exten => a_exten,n,NoOp(A READ IS ${A_READ})

;CHECK DTMF FROM C
exten => a_exten,n,Set(GLOBAL(BLONDE_TEST_A_LEG)=FAIL-while checking dtmf from C results)
exten => a_exten,n,GoToIf($[${A_READ}=100]?dtmfpass:dtmffail)
exten => a_exten,n(dtmffail),Set(GLOBAL(BLONDE_TEST_A_LEG)=FAIL-DTMF_FROM_C_FAILED ${A_READ})
exten => a_exten,n,Hangup()
exten => a_exten,n(dtmfpass),Set(GLOBAL(BLONDE_TEST_A_LEG)=FAIL-Got DTMF from C A_READ is ${A_READ} now performing audio detect)

;DETECT AUDIO
exten => a_exten,n,Set(TALK_DETECTED=0) ; initialize TALK_DETECT var
exten => a_exten,n,BackgroundDetect(${TALK_AUDIO},1,20,,20000) ; lets see if we have 2 way audio

;CHECK AUDIO RESULTS
exten => a_exten,n,Set(GLOBAL(BLONDE_TEST_A_LEG)=FAIL-checking talk detect results)
exten => a_exten,n,GoToIf($[${TALK_DETECTED}=0]?talkdetectfail:talkdetectpass)
exten => a_exten,n(talkdetectfail),Set(GLOBAL(BLONDE_TEST_A_LEG)=FAIL-talk detect failed TALK_DETECTED is ${TALK_DETECTED})
exten => a_exten,n,Hangup()

;PASSED ! we make it to this point in the dial plan, A has passed.
exten => a_exten,n(talkdetectpass),Set(GLOBAL(BLONDE_TEST_A_LEG)=PASS)

;REPORT SUCCESS, at this point in the dialplay this call leg passed.
exten => a_exten,n,AGI(agi://127.0.0.1:4573) ;Tell the test script A passed

; since both channels are attempted to detect audio, we must play this file twice because
; we can not guarantee who broke out of BackgroundDetect first
exten => a_exten,n,Playback(${TALK_AUDIO})

; __________________ C  ______________________
exten => c_exten,1,Set(GLOBAL(BLONDE_TEST_C_LEG)=FAIL-extension was called)

;Wait after entering dialplan for B to hangup.
exten => c_exten,n,Ringing()
exten => c_exten,n,Wait(2)
exten => c_exten,n,Set(GLOBAL(BLONDE_TEST_C_LEG)=FAIL-after waiting before answer)
exten => c_exten,n,Answer()

exten => c_exten,n,Set(GLOBAL(BLONDE_TEST_C_LEG)=FAIL-extension was answered)

; Play the same amount of audio A does in while waiting to guarantee
; A is ready to receive DTMF before we send it.
exten => c_exten,n,Playback(${TALK_AUDIO})
exten => c_exten,n,Playback(${TALK_AUDIO})
exten => c_exten,n,Playback(${TALK_AUDIO})
exten => c_exten,n,Playback(${TALK_AUDIO})

;SEND DTMF TO A SIGNALLING WE ARE HERE, b hung up, now we should be talking to A
exten => c_exten,n,SendDTMF(1w0w0w) ; send some dtmf to A
exten => c_exten,n,Set(GLOBAL(BLONDE_TEST_C_LEG)=FAIL-sent dtmf to A now performing audio detect)

;DETECT AUDIO
exten => c_exten,n,Set(TALK_DETECTED=0) ; initialize TALK_DETECTED var
exten => c_exten,n,BackgroundDetect(${TALK_AUDIO},1,20,,20000) ; lets see if we have some 2 way audio

;CHECK AUDIO RESULTS
exten => c_exten,n,Set(GLOBAL(BLONDE_TEST_C_LEG)=FAIL-checking talk detect results)
exten => c_exten,n,GoToIf($[${TALK_DETECTED}=0]?talkdetectfail:talkdetectpass)
exten => c_exten,n(talkdetectfail),Set(GLOBAL(BLONDE_TEST_C_LEG)=FAIL-talk detect failed TALK_DETECT is ${TALK_DETECTED})
exten => c_exten,n,Hangup()

;PASSED ! we make it to this point in the dial plan, C has passed.
exten => c_exten,n(talkdetectpass),Set(GLOBAL(BLONDE_TEST_C_LEG)=PASS)

;REPORT SUCCESS, at this point in the dialplay this call leg passed.
exten => c_exten,n,AGI(agi://127.0.0.1:4575) ;Tell the test script C passed

; Since both channels are attempted to detect audio, we must continue to play
; this file because we can not guarantee who broke out of BackgroundDetect first.
exten => c_exten,n,Playback(${TALK_AUDIO})

